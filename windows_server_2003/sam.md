### SAM {#sam}

| 安全帐户管理器 SAM(security account manager) |
| --- |

Windows NT 及 Windows2000 中对用户帐户的安全管理使用了安全帐户管理器 (security account manager) 的机制，安全帐户管理器对帐户的管理是通过安全标识进行的，安全标识在帐户创建时就同时创建，一旦帐户被删除，安全标识也同时被删除。安全标识是唯一的，即使是相同的用户名，在每次创建时获得的安全标识都时完全不同的。因此，一旦某个帐户被删除，它的安全标识就不再存在了，即使用相同的用户名重建帐户，也会被赋予不同的安全标识，不会保留原来的权限。

安全账号管理器的具体表现就是 %SystemRoot%\\system32\\config\\sam 文件。 SAM 文件是 Windows NT 的用户帐户 [数据](http://www.3800hk.com/) 库，所有 NT 用户的登录名及口令等相关信息都会保存在这个文件中。 SAM 文件可以认为类似于 Unix 系统中的 Passwd 文件 , 不过没有这么直观明了。 Passwd 使用的是存文本的格式保存信息，这是一个 Linux Passwd 文件内容的例子：

0: root:8L7v6:0:0:root:/root:/bin/bash

1: bin:*:1:1:bin:/bin:

2: daemon:*:2:2:daemon:/sbin:

3: adm:*:3:4:adm:/var/adm:

4: lp:*:4:7:lp:/var/spool/lpd:

5: sync:*:5:0:sync:/sbin:/bin/sync

6: shutdown:*:6:0:shutdown:/sbin:/sbin/shutdown

7: halt:*:7:0:halt:/sbin:/sbin/halt

8: mail:*:8:12:mail:/var/spool/mail:

9: news:*:9:13:news:/var/spool/news :

10: uucp:*:10:14:uucp:/var/spool/uucp:

11: operator:*:11:0perator:/root:

12: games:*:12:100:games:/usr/games:

13: gopher:*:13:30:gopher:/usr/lib/gopher-data :

14: ftp:*:14:50:FTP User:/home/ftp:

15: nobody:I0iJ.:99:99:Nobody:/home/httpd:/bin/bash

16: david:c6CuzM:500:500::/home/david:/bin/bash

17: dummy:fIVTl4IgU:501:503::/home/dummy:/bin/bash

18: msql:!!:502:504::/home/msql:/bin/bash

|  |
| --- |

Unix 中的 Passwd 文件中每一行都代表一个用户资料，每一个账号都有七部分资料，不同资料中使用 &quot;:&quot; 分割格式如下，

账号名称 : 密码 :uid:gid: 个人资料 : 用户目录 :shell

|  |
| --- |

除了密码是加密的以外 ( 这里的密码部分已经 Shadow 了 ) 其他项目非常清楚明了。

而 NT 中就不是这样，虽然他也是用文件保存账号信息，不过如果我们用编辑器打开这些 NT 的 SAM 文件，除了乱码什么也看不到。因为 NT 系统中将这些资料全部进行了加密处理，一般的编辑器是无法直接读取这些信息的。注册表中的

HKEY_LOCAL_MACHINE\\SAM\\SAM

HKEY_LOCAL_MACHINE\\SECURITY\\SAM

|  |
| --- |

保存的就是 SAM 文件的内容，在正常设置下仅对 System 是可读写的。

**NT** **的帐户信息在** **SAM** **文件中是如何存储的呢？**

在 SAM 文件中保存了两个不同的口令信息： LanManager （ LM ）口令散列算法和更加强大的加密 NT 版， LM 就是 NT 口令文件的弱点。我们来看看 LM 口令算法是如何加密口令的，考虑这样一个口令： Ba01cK28tr ，这样的口令已经可以称的上是一个安全的口令了，虽然没有 !# 等特殊字符，但是已经包含大写字母，小写字母和数字，并且具有无规律性。可以认为是符合安全的要求的一个口令。

LM 对口令的处理方法是：如果口令不足 14 位，就用 0 把口令补足 14 位，并把所有的字母转称大写字母。之后将处理后的口令分成两组数字，每组是 7 位。刚才我们所提到的口令经处理后就变成 BA01CK2 和 8TR0000 部分。然后由这两个 7 位的数字分别生成 8 位的 DES KEY ，每一个 8 位的 DES KEY 都使用一个魔法数字 ( 将 0x4B47532140232425 用全是 1 的一个 KEY 进行加密获得的 ) 再进行一次加密，将两组加密完后的字符串连在一起，这就是最终的口令散列。这个字符传看起来是个整体，但是象 L0phtcrack 这样的破解软件，他能将口令字符串的两部分独立的破解。因此，破解上面所提到口令 (10 位 ) ，由于口令已经被分解为两部分破解，而后面的那部分口令由于只有 3 位，破解难度可想而知并不困难。实际的难度就在前面的七位口令上了。因此就 NT 而言，一个 10 位的口令与一个 7 位的口令相比并没有太高的安全意义。由此还可以了解： 1234567*$# 这样的口令可能还不如 SHic6 这样的口令安全。 ( 关于如何设置安全口令的问题不是本文的范围，有兴趣的可以参考相关文章 )

而正式的口令 ( 加密 NT 版 ) 是将用户的口令转换成 unicode 编码，然后使用 MD4 算法将口令加密。

NT 之所以保留两种不同版本的口令是由于历史原因造成的，在一个纯 NT 的环境中应该将 LAN manager 口令关闭。因为 LAN manager 口令使用了较弱的 DES 密钥和算法，比较容易破解。相比较之下，使用较强加密算法的 NT 正式口令要安全些。

但是这两种口令的加密方法从总体上来说强度还是不足，因此，微软在 Win NT4 的 SP3 之和以后的补丁中，提供了一个 Syskey.exe 的小工具来进一步加强 NT 的口令。这个软件是可以选择使用的，管理员只要运行一下这个程序并回答一些设置问题就可以添加这项增强功能。 (Windows2000 已经作为缺省安装设置了 )

**Syskey** **被设计用来防止轻易获得** **SAM** **口令，它是如何工作的呢？**

当 Syskey 被激活，口令信息在存入注册表之前还进行了一次加密处理。然而，在机器启动后，一个旧的格式的信息还是会保存在内存中。因为，这个旧格式的口令信息是进行 [网络](http://www.3800hk.com/) 验证的所需要的。

可以这样认为： Syskey 使用了一种方法将口令信息搞乱。或者说使用了一个密钥，这个密钥是激活 Syskey 由用户选择保存位置的。这个密钥可以保存在软盘，或者在启动时由用户生成 ( 通过用户输入的口令生成 ) ，又或者直接保存在注册表中。由于没有官方的正式